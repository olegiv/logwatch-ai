# macOS Setup Guide for Logwatch AI Analyzer

This guide provides macOS-specific instructions for using the Logwatch AI Analyzer.

## Overview

The Logwatch AI Analyzer uses a cron-based approach where logwatch reports are pre-generated by a cron job running as root, and the Node.js application simply reads the generated files. **No sudo is required in JavaScript code.**

## Quick Setup

### Option 1: Use Cron (Recommended for Automation)

Set up a root cron job to generate logwatch reports automatically:

```bash
# Edit root's crontab
sudo crontab -e

# Add this line to run daily at 2 AM:
0 2 * * * /path/to/logwatch-ai/scripts/generate-logwatch.sh
```

The script automatically:
1. Runs logwatch as root (has access to all system logs)
2. Generates report with --detail 0 (minimal verbosity by default)
3. Sets file permissions to 644 (world-readable)
4. Logs to syslog for monitoring

See [docs/CRON_SETUP.md](docs/CRON_SETUP.md) for detailed instructions.

### Option 2: Manual Generation (For Testing)

Use the helper script to generate a report manually:

```bash
# Generate logwatch for yesterday (requires sudo to access system logs)
sudo ./scripts/generate-logwatch.sh

# Or with custom parameters (path, detail 0-10, range):
sudo ./scripts/generate-logwatch.sh /tmp/logwatch-output.txt 5 yesterday

# Then run the analyzer
npm start
```

### Option 3: Using Launchd (Alternative to Cron)

macOS also supports launchd for scheduled tasks. See [docs/CRON_SETUP.md](docs/CRON_SETUP.md) for launchd configuration examples.

## Architecture

**Old approach** (removed):
- Node.js app spawned sudo commands
- Required passwordless sudo configuration
- Security concerns with sudo in application code

**New approach** (current):
- Cron job runs as root to generate logwatch
- Node.js app only reads pre-generated file
- Better security (separation of privileges)
- No sudo in JavaScript code

Now the analyzer can auto-generate logwatch reports without password prompts.

## Complete Workflow

### Manual Execution

```bash
# Step 1: Generate logwatch report with proper permissions
./scripts/generate-logwatch.sh yesterday

# Step 2: Run the analyzer
npm start
```

### Automated Execution with Cron

1. Set up root cron job to generate logwatch:
```bash
# Edit root crontab
sudo crontab -e

# Add this line to run daily at 2 AM:
0 2 * * * /path/to/logwatch-ai/scripts/generate-logwatch.sh
```

2. Set up user cron job to run analyzer (runs at 2:15 AM, after logwatch generation):
```bash
# Edit your user crontab
crontab -e

# Add this line:
15 2 * * * cd /path/to/logwatch-ai && /usr/local/bin/node src/analyzer.js >> logs/cron.log 2>&1
```

### One-Line Execution

For convenience, create an alias in your `.zshrc` or `.bash_profile`:

```bash
alias analyze-logs='cd /Users/olegiv/Desktop/Projects/AI/logwatch-ai && ./scripts/generate-logwatch.sh yesterday && npm start'
```

Then just run:
```bash
analyze-logs
```

## Troubleshooting

### "Permission denied" when reading logwatch file

**Problem:** File is owned by root with 600 permissions

**Solution:** Use the generate-logwatch.sh script or manually fix permissions:
```bash
sudo chmod 644 /tmp/logwatch-output.txt
sudo chown $(whoami):staff /tmp/logwatch-output.txt
```

### "Logwatch file not found" error

**Problem:** Analyzer can't find pre-generated logwatch file

**Solution:**
1. Ensure root cron job is set up: `sudo crontab -l`
2. Generate manually to test: `sudo ./scripts/generate-logwatch.sh`
3. Check file exists: `ls -l /tmp/logwatch-output.txt`
4. See [docs/CRON_SETUP.md](docs/CRON_SETUP.md) for troubleshooting

### Logwatch not found

**Problem:** Logwatch not installed or wrong path

**Solution:**
```bash
# Install via MacPorts
sudo port install logwatch

# Or find the correct path
which logwatch
```

## macOS vs Linux Differences

| Feature | Linux | macOS |
|---------|-------|-------|
| Default logwatch path | `/usr/sbin/logwatch` | `/opt/local/bin/logwatch` |
| Default output | `/tmp/` | `/tmp/` |
| Cron service | `systemd` or `cron` | `launchd` or `cron` |
| Log locations | `/var/log/*` | `/var/log/*` and system logs |

## Alternative: launchd (macOS Native Scheduler)

Instead of cron, you can use launchd:

1. Create file: `~/Library/LaunchAgents/com.logwatch.analyzer.plist`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.logwatch.analyzer</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-c</string>
        <string>cd /Users/olegiv/Desktop/Projects/AI/logwatch-ai && ./scripts/generate-logwatch.sh yesterday && /usr/local/bin/node src/analyzer.js</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>6</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>
    <key>StandardOutPath</key>
    <string>/Users/olegiv/Desktop/Projects/AI/logwatch-ai/logs/launchd.log</string>
    <key>StandardErrorPath</key>
    <string>/Users/olegiv/Desktop/Projects/AI/logwatch-ai/logs/launchd-error.log</string>
</dict>
</plist>
```

2. Load the agent:
```bash
launchctl load ~/Library/LaunchAgents/com.logwatch.analyzer.plist
```

3. Test it:
```bash
launchctl start com.logwatch.analyzer
```

## Summary

**For manual use:** Use `./scripts/generate-logwatch.sh` then `npm start`

**For automation:** Set up passwordless sudo + cron or use launchd

**Quick test:** `./scripts/generate-logwatch.sh today && npm start`
